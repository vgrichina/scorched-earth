// Scorched Earth - Proportional Bitmap Font (Fastgraph V4.02)
// Extracted from SCORCH.EXE font initialization at file 0x4C290
// EXE: Fastgraph internal bitmap font, NOT the VGA BIOS 8x8 font
// Font format: variable width per character, 12 rows per glyph
// Each glyph: 1 byte width + width*12 bytes of byte-per-pixel data (in EXE)
// Here stored as packed bits: 1 byte per row, MSB = leftmost pixel
// EXE: text_measure adds (width + 1) per character for inter-character spacing

import { setPixel } from './framebuffer.js';

export const FONT_HEIGHT = 12;  // EXE: glyph rendering loop "cmp si, 0xc"

// Per-character widths for ASCII 32-126 (95 chars)
// EXE: first byte of glyph data at DS:[char*4 - 0xCA6] -> far ptr -> [0] = width
const WIDTHS = new Uint8Array([
  4, 1, 0, 5, 5, 6, 5, 2, 3, 3, 5, 5, 3, 5, 2, 5,  //  !"#$%&'()*+,-./
  5, 4, 5, 5, 5, 5, 5, 5, 5, 5, 2, 2, 4, 5, 4, 5,  // 0123456789:;<=>?
  5, 5, 5, 5, 5, 5, 5, 5, 5, 3, 5, 5, 5, 5, 5, 5,  // @ABCDEFGHIJKLMNO
  5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 3, 5, 3, 5, 5,  // PQRSTUVWXYZ[\]^_
  3, 5, 5, 5, 5, 5, 3, 5, 5, 3, 3, 4, 3, 5, 5, 5,  // `abcdefghijklmno
  5, 5, 4, 5, 3, 5, 5, 5, 5, 5, 5, 4, 1, 4, 5,     // pqrstuvwxyz{|}~
]);

// Packed bitmap data: 12 bytes per character, 1 byte per row, MSB = leftmost pixel
// Extracted from DS:0x70E4+ in SCORCH.EXE (file base 0x05CE64)
const GLYPHS = new Uint8Array([
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 32: space (w=4)
  0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x80,0x00,0x00,  // 33: ! (w=1)
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 34: " (w=0)
  0x00,0x00,0x00,0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00,0x00,  // 35: # (w=5)
  0x00,0x00,0x00,0x70,0xA8,0xA0,0x70,0x28,0xA8,0x70,0x00,0x00,  // 36: $ (w=5)
  0x00,0x00,0xC0,0xC4,0x08,0x10,0x20,0x40,0x8C,0x0C,0x00,0x00,  // 37: % (w=6)
  0x00,0x00,0x00,0x60,0x90,0x90,0x68,0x90,0x90,0x68,0x00,0x00,  // 38: & (w=5)
  0x00,0x00,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // 39: ' (w=2)
  0x00,0x00,0x00,0x20,0x40,0x80,0x80,0x80,0x40,0x20,0x00,0x00,  // 40: ( (w=3)
  0x00,0x00,0x00,0x80,0x40,0x20,0x20,0x20,0x40,0x80,0x00,0x00,  // 41: ) (w=3)
  0x00,0x00,0x00,0x00,0xA8,0x70,0xF8,0x70,0xA8,0x00,0x00,0x00,  // 42: * (w=5)
  0x00,0x00,0x00,0x00,0x20,0x20,0xF8,0x20,0x20,0x00,0x00,0x00,  // 43: + (w=5)
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x60,0x40,0x80,  // 44: , (w=3)
  0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,  // 45: - (w=5)
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,  // 46: . (w=2)
  0x00,0x00,0x00,0x00,0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,  // 47: / (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00,0x00,  // 48: 0 (w=5)
  0x00,0x00,0x00,0x20,0x60,0x20,0x20,0x20,0x20,0x70,0x00,0x00,  // 49: 1 (w=4)
  0x00,0x00,0x00,0x70,0x88,0x08,0x10,0x20,0x40,0xF8,0x00,0x00,  // 50: 2 (w=5)
  0x00,0x00,0x00,0x70,0x88,0x08,0x30,0x08,0x88,0x70,0x00,0x00,  // 51: 3 (w=5)
  0x00,0x00,0x00,0x10,0x30,0x50,0xF8,0x10,0x10,0x10,0x00,0x00,  // 52: 4 (w=5)
  0x00,0x00,0x00,0xF8,0x80,0xB0,0xC8,0x08,0x88,0x70,0x00,0x00,  // 53: 5 (w=5)
  0x00,0x00,0x00,0x08,0x30,0x40,0xF0,0x88,0x88,0x70,0x00,0x00,  // 54: 6 (w=5)
  0x00,0x00,0x00,0xF8,0x08,0x10,0x20,0x40,0x80,0x80,0x00,0x00,  // 55: 7 (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00,0x00,  // 56: 8 (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0x78,0x08,0x88,0x70,0x00,0x00,  // 57: 9 (w=5)
  0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0xC0,0xC0,0x00,0x00,  // 58: : (w=2)
  0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0xC0,0xC0,0x80,0x00,  // 59: ; (w=2)
  0x00,0x00,0x00,0x10,0x20,0x40,0x80,0x40,0x20,0x10,0x00,0x00,  // 60: < (w=4)
  0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00,0x00,  // 61: = (w=5)
  0x00,0x00,0x00,0x80,0x40,0x20,0x10,0x20,0x40,0x80,0x00,0x00,  // 62: > (w=4)
  0x00,0x00,0x00,0x70,0x88,0x08,0x10,0x20,0x00,0x20,0x00,0x00,  // 63: ? (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0xB8,0xB0,0x80,0x78,0x00,0x00,  // 64: @ (w=5)
  0x00,0x00,0x00,0x20,0x50,0x88,0xF8,0x88,0x88,0x88,0x00,0x00,  // 65: A (w=5)
  0x00,0x00,0x00,0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00,0x00,  // 66: B (w=5)
  0x00,0x00,0x00,0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00,0x00,  // 67: C (w=5)
  0x00,0x00,0x00,0xF0,0x88,0x88,0x88,0x88,0x88,0xF0,0x00,0x00,  // 68: D (w=5)
  0x00,0x00,0x00,0xF8,0x80,0x80,0xE0,0x80,0x80,0xF8,0x00,0x00,  // 69: E (w=5)
  0x00,0x00,0x00,0xF8,0x80,0x80,0xE0,0x80,0x80,0x80,0x00,0x00,  // 70: F (w=5)
  0x00,0x00,0x00,0x70,0x88,0x80,0xB8,0x88,0x88,0x70,0x00,0x00,  // 71: G (w=5)
  0x00,0x00,0x00,0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00,0x00,  // 72: H (w=5)
  0x00,0x00,0x00,0xE0,0x40,0x40,0x40,0x40,0x40,0xE0,0x00,0x00,  // 73: I (w=3)
  0x00,0x00,0x00,0x38,0x10,0x10,0x10,0x10,0x90,0x60,0x00,0x00,  // 74: J (w=5)
  0x00,0x00,0x00,0x88,0x90,0xA0,0xC0,0xA0,0x90,0x88,0x00,0x00,  // 75: K (w=5)
  0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00,0x00,  // 76: L (w=5)
  0x00,0x00,0x00,0x88,0xD8,0xA8,0x88,0x88,0x88,0x88,0x00,0x00,  // 77: M (w=5)
  0x00,0x00,0x00,0x88,0xC8,0xC8,0xA8,0x98,0x98,0x88,0x00,0x00,  // 78: N (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00,0x00,  // 79: O (w=5)
  0x00,0x00,0x00,0xF0,0x88,0x88,0x88,0xF0,0x80,0x80,0x00,0x00,  // 80: P (w=5)
  0x00,0x00,0x00,0x70,0x88,0x88,0x88,0xA8,0x98,0x78,0x00,0x00,  // 81: Q (w=5)
  0x00,0x00,0x00,0xF0,0x88,0x88,0x88,0xF0,0x90,0x88,0x00,0x00,  // 82: R (w=5)
  0x00,0x00,0x00,0x70,0x88,0x80,0x70,0x08,0x88,0x70,0x00,0x00,  // 83: S (w=5)
  0x00,0x00,0x00,0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,  // 84: T (w=5)
  0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00,0x00,  // 85: U (w=5)
  0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x88,0x50,0x20,0x00,0x00,  // 86: V (w=5)
  0x00,0x00,0x00,0x88,0x88,0x88,0x88,0xA8,0xD8,0x88,0x00,0x00,  // 87: W (w=5)
  0x00,0x00,0x00,0x88,0x50,0x50,0x20,0x50,0x50,0x88,0x00,0x00,  // 88: X (w=5)
  0x00,0x00,0x00,0x88,0x88,0x50,0x20,0x20,0x20,0x20,0x00,0x00,  // 89: Y (w=5)
  0x00,0x00,0x00,0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00,0x00,  // 90: Z (w=5)
  0x00,0x00,0x00,0xE0,0x80,0x80,0x80,0x80,0x80,0xE0,0x00,0x00,  // 91: [ (w=3)
  0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,  // 92: \ (w=5)
  0x00,0x00,0x00,0xE0,0x20,0x20,0x20,0x20,0x20,0xE0,0x00,0x00,  // 93: ] (w=3)
  0x00,0x00,0x00,0x00,0x20,0x50,0x88,0x00,0x00,0x00,0x00,0x00,  // 94: ^ (w=5)
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,  // 95: _ (w=5)
  0x00,0x00,0x00,0x00,0x80,0x40,0x20,0x00,0x00,0x00,0x00,0x00,  // 96: ` (w=3)
  0x00,0x00,0x00,0x00,0x00,0x70,0x08,0x78,0x88,0x78,0x00,0x00,  // 97: a (w=5)
  0x00,0x00,0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0xF0,0x00,0x00,  // 98: b (w=5)
  0x00,0x00,0x00,0x00,0x00,0x78,0x80,0x80,0x80,0x78,0x00,0x00,  // 99: c (w=5)
  0x00,0x00,0x00,0x08,0x08,0x78,0x88,0x88,0x88,0x78,0x00,0x00,  // 100: d (w=5)
  0x00,0x00,0x00,0x00,0x00,0x70,0x88,0xF8,0x80,0x70,0x00,0x00,  // 101: e (w=5)
  0x00,0x00,0x00,0x20,0x40,0x40,0xE0,0x40,0x40,0x40,0x00,0x00,  // 102: f (w=3)
  0x00,0x00,0x00,0x00,0x00,0x78,0x88,0x88,0x88,0x78,0x08,0x30,  // 103: g (w=5)
  0x00,0x00,0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x88,0x00,0x00,  // 104: h (w=5)
  0x00,0x00,0x00,0x40,0x00,0xC0,0x40,0x40,0x40,0xE0,0x00,0x00,  // 105: i (w=3)
  0x00,0x00,0x00,0x20,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0xC0,  // 106: j (w=3)
  0x00,0x00,0x00,0x80,0x80,0x90,0xE0,0x80,0xE0,0x90,0x00,0x00,  // 107: k (w=4)
  0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0x40,0xE0,0x00,0x00,  // 108: l (w=3)
  0x00,0x00,0x00,0x00,0x00,0xD0,0xA8,0xA8,0xA8,0xA8,0x00,0x00,  // 109: m (w=5)
  0x00,0x00,0x00,0x00,0x00,0xF0,0x88,0x88,0x88,0x88,0x00,0x00,  // 110: n (w=5)
  0x00,0x00,0x00,0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00,0x00,  // 111: o (w=5)
  0x00,0x00,0x00,0x00,0x00,0xF0,0x88,0x88,0x88,0xF0,0x80,0x80,  // 112: p (w=5)
  0x00,0x00,0x00,0x00,0x00,0x78,0x88,0x88,0x88,0x78,0x08,0x08,  // 113: q (w=5)
  0x00,0x00,0x00,0x00,0x00,0xB0,0xC0,0x80,0x80,0x80,0x00,0x00,  // 114: r (w=4)
  0x00,0x00,0x00,0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00,0x00,  // 115: s (w=5)
  0x00,0x00,0x00,0x00,0x40,0xE0,0x40,0x40,0x40,0x20,0x00,0x00,  // 116: t (w=3)
  0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x78,0x00,0x00,  // 117: u (w=5)
  0x00,0x00,0x00,0x00,0x00,0x88,0x50,0x50,0x20,0x20,0x00,0x00,  // 118: v (w=5)
  0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0xA8,0x50,0x00,0x00,  // 119: w (w=5)
  0x00,0x00,0x00,0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00,0x00,  // 120: x (w=5)
  0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x78,0x08,0x30,  // 121: y (w=5)
  0x00,0x00,0x00,0x00,0x00,0xF8,0x10,0x20,0x40,0xF8,0x00,0x00,  // 122: z (w=5)
  0x00,0x00,0x00,0x30,0x40,0x40,0x80,0x40,0x40,0x30,0x00,0x00,  // 123: { (w=4)
  0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,  // 124: | (w=1)
  0x00,0x00,0x00,0xC0,0x20,0x20,0x10,0x20,0x20,0xC0,0x00,0x00,  // 125: } (w=4)
  0x00,0x00,0x08,0x70,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 126: ~ (w=5)
]);

// Get the pixel width of a single character (without spacing)
function charWidth(code) {
  if (code < 32 || code > 126) return 0;
  return WIDTHS[code - 32];
}

// Draw a single character at (x, y) using palette colorIndex
// Returns the advance width (glyph width + 1px spacing), matching EXE text_measure
function drawChar(ch, x, y, colorIndex) {
  const code = ch.charCodeAt(0);
  if (code < 32 || code > 126) return 0;
  const idx = code - 32;
  const width = WIDTHS[idx];
  if (width === 0) return 1; // zero-width glyph still advances 1px
  const offset = idx * FONT_HEIGHT;

  for (let row = 0; row < FONT_HEIGHT; row++) {
    const bits = GLYPHS[offset + row];
    for (let col = 0; col < width; col++) {
      if (bits & (0x80 >> col)) {
        setPixel(x + col, y + row, colorIndex);
      }
    }
  }
  return width + 1; // EXE: text_measure does width + 1 for inter-character spacing
}

// Draw a string at (x, y) with given palette color index
// Returns the width in pixels
// EXE: text_display at file 0x4C914 skips '~' (0x7E) hotkey markers
export function drawText(x, y, str, colorIndex) {
  let cx = x;
  for (let i = 0; i < str.length; i++) {
    if (str.charCodeAt(i) === 0x7E) continue; // skip ~ hotkey marker
    cx += drawChar(str[i], cx, y, colorIndex);
  }
  return cx - x;
}

// Draw text with a shadow (dark outline for readability)
export function drawTextShadow(x, y, str, colorIndex, shadowIndex) {
  drawText(x + 1, y + 1, str, shadowIndex);
  drawText(x, y, str, colorIndex);
}

// EXE: title_3d_text at file 0x4CEFD (0x4589:0x0C6D) — 5-layer embossed title
// Renders same string 5 times at pixel offsets (0,0)→(4,4), each in a different color.
// EXE layer order: DS:0xEF2C(deep shadow), DS:0xEF32(bright), DS:0xEF24(dark),
//   DS:0xEF2A(light), DS:0xEF26(dark border/top surface)
export function drawTextEmbossed(x, y, str, colors) {
  for (let i = 0; i < 5; i++) {
    drawText(x + i, y + i, str, colors[i]);
  }
}

// Measure text width in pixels (for centering calculations)
// EXE: text_measure at file 0x4CE17 — sums (charWidth + 1) per character, skips '~'
export function measureText(str) {
  let w = 0;
  for (let i = 0; i < str.length; i++) {
    const code = str.charCodeAt(i);
    if (code === 0x7E) continue; // skip ~ hotkey marker (EXE: cmp di, 0x7E; jz skip)
    if (code < 32 || code > 126) continue;
    const cw = WIDTHS[code - 32];
    w += cw + 1; // EXE: width + 1 for spacing
  }
  return w;
}
