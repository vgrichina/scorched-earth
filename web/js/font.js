// Scorched Earth - 8x8 Bitmap Font (PC BIOS/VGA CP437)
// EXE: uses standard IBM VGA BIOS 8x8 font (INT 10h, AH=1130h font pointer)
// EXE: rendered via Fastgraph V4.02 text routines into Mode 13h framebuffer
// Each glyph is 8 bytes; each byte is one row, MSB = leftmost pixel
// Renders directly into the indexed framebuffer

import { setPixel } from './framebuffer.js';
import { CHAR_W, CHAR_H } from './constants.js';

// CP437 8x8 font data for printable ASCII 32-127
// Standard IBM VGA BIOS font
const GLYPHS = new Uint8Array([
  // 32: space
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  // 33: !
  0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00,
  // 34: "
  0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00,
  // 35: #
  0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00,
  // 36: $
  0x18,0x7E,0xC0,0x7C,0x06,0xFC,0x18,0x00,
  // 37: %
  0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00,
  // 38: &
  0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00,
  // 39: '
  0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,
  // 40: (
  0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00,
  // 41: )
  0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00,
  // 42: *
  0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,
  // 43: +
  0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,
  // 44: ,
  0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30,
  // 45: -
  0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,
  // 46: .
  0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,
  // 47: /
  0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,
  // 48: 0
  0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00,
  // 49: 1
  0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00,
  // 50: 2
  0x7C,0xC6,0x06,0x1C,0x30,0x66,0xFE,0x00,
  // 51: 3
  0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00,
  // 52: 4
  0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00,
  // 53: 5
  0xFE,0xC0,0xFC,0x06,0x06,0xC6,0x7C,0x00,
  // 54: 6
  0x38,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00,
  // 55: 7
  0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00,
  // 56: 8
  0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00,
  // 57: 9
  0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00,
  // 58: :
  0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00,
  // 59: ;
  0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30,
  // 60: <
  0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00,
  // 61: =
  0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00,
  // 62: >
  0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00,
  // 63: ?
  0x7C,0xC6,0x0C,0x18,0x18,0x00,0x18,0x00,
  // 64: @
  0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00,
  // 65: A
  0x38,0x6C,0xC6,0xFE,0xC6,0xC6,0xC6,0x00,
  // 66: B
  0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00,
  // 67: C
  0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,
  // 68: D
  0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00,
  // 69: E
  0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00,
  // 70: F
  0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00,
  // 71: G
  0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00,
  // 72: H
  0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00,
  // 73: I
  0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,
  // 74: J
  0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00,
  // 75: K
  0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00,
  // 76: L
  0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,
  // 77: M
  0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00,
  // 78: N
  0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00,
  // 79: O
  0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,
  // 80: P
  0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,
  // 81: Q
  0x7C,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0E,
  // 82: R
  0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00,
  // 83: S
  0x7C,0xC6,0xE0,0x7C,0x06,0xC6,0x7C,0x00,
  // 84: T
  0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00,
  // 85: U
  0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,
  // 86: V
  0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,
  // 87: W
  0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00,
  // 88: X
  0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00,
  // 89: Y
  0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00,
  // 90: Z
  0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00,
  // 91: [
  0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,
  // 92: backslash
  0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,
  // 93: ]
  0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,
  // 94: ^
  0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,
  // 95: _
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
  // 96: `
  0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,
  // 97: a
  0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00,
  // 98: b
  0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00,
  // 99: c
  0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00,
  // 100: d
  0x1C,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,
  // 101: e
  0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00,
  // 102: f
  0x38,0x6C,0x60,0xF0,0x60,0x60,0xF0,0x00,
  // 103: g
  0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8,
  // 104: h
  0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00,
  // 105: i
  0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00,
  // 106: j
  0x06,0x00,0x06,0x06,0x06,0x66,0x66,0x3C,
  // 107: k
  0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00,
  // 108: l
  0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,
  // 109: m
  0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0x00,
  // 110: n
  0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00,
  // 111: o
  0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00,
  // 112: p
  0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0,
  // 113: q
  0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E,
  // 114: r
  0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00,
  // 115: s
  0x00,0x00,0x7C,0xC0,0x7C,0x06,0xFC,0x00,
  // 116: t
  0x30,0x30,0x7C,0x30,0x30,0x36,0x1C,0x00,
  // 117: u
  0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00,
  // 118: v
  0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x00,
  // 119: w
  0x00,0x00,0xC6,0xD6,0xD6,0xFE,0x6C,0x00,
  // 120: x
  0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00,
  // 121: y
  0x00,0x00,0xC6,0xC6,0xCE,0x76,0x06,0xC6,
  // 122: z
  0x00,0x00,0xFC,0x98,0x30,0x64,0xFC,0x00,
  // 123: {
  0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00,
  // 124: |
  0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00,
  // 125: }
  0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00,
  // 126: ~
  0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,
  // 127: del (block)
  0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0x00,
]);

// Draw a single character at (x, y) using palette colorIndex
function drawChar(ch, x, y, colorIndex) {
  const code = ch.charCodeAt(0);
  if (code < 32 || code > 127) return CHAR_W; // skip unprintable, still advance
  const offset = (code - 32) * CHAR_H;

  for (let row = 0; row < CHAR_H; row++) {
    const bits = GLYPHS[offset + row];
    for (let col = 0; col < CHAR_W; col++) {
      if (bits & (0x80 >> col)) {
        setPixel(x + col, y + row, colorIndex);
      }
    }
  }
  return CHAR_W; // character width (fixed 8px)
}

// Draw a string at (x, y) with given palette color index
// Returns the width in pixels
export function drawText(x, y, str, colorIndex) {
  let cx = x;
  for (let i = 0; i < str.length; i++) {
    cx += drawChar(str[i], cx, y, colorIndex);
  }
  return cx - x;
}

// Draw text with a shadow (dark outline for readability)
export function drawTextShadow(x, y, str, colorIndex, shadowIndex) {
  drawText(x + 1, y + 1, str, shadowIndex);
  drawText(x, y, str, colorIndex);
}
